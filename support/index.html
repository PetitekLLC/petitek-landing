from flask import Flask, request, jsonify
from flask_cors import CORS
import traceback
from openai import OpenAI
import os
import re
from dotenv import load_dotenv

# Load environment variables
load_dotenv()

# Set these in Render's environment settings
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")
OPENAI_PROJECT_ID = os.getenv("OPENAI_PROJECT_ID")

# Initialize OpenAI client (project mode)
client = OpenAI(
    api_key=OPENAI_API_KEY,
    project=OPENAI_PROJECT_ID
)

# Your Assistant ID
ASSISTANT_ID = "asst_pEJ28b9SuNeeOGfLtRDGppR0"

# Flask app setup
app = Flask(__name__)
CORS(app)

# Clean up citations and source tags
def clean_response(text):
    text = re.sub(r'\[\d+:\d+(?:\^.*?)?\]', '', text)  # Removes [4:0^source], [4:0^filename], etc.
    text = re.sub(r'\[\d+:\d+\]', '', text)            # Removes leftover [4:0] style
    return text.strip()

@app.route("/", methods=["GET"])
def home():
    return "âœ… ChatrBox Assistant Backend is running."

@app.route("/chat", methods=["POST"])
def chat():
    data = request.get_json()
    user_message = data.get("message", "")
    print("ðŸ“¨ Received message:", user_message)

    try:
        thread = client.beta.threads.create()

        client.beta.threads.messages.create(
            thread_id=thread.id,
            role="user",
            content=user_message
        )

        run = client.beta.threads.runs.create_and_poll(
            thread_id=thread.id,
            assistant_id=ASSISTANT_ID
        )

        messages = client.beta.threads.messages.list(thread_id=thread.id)
        raw_reply = messages.data[0].content[0].text.value
        final_reply = clean_response(raw_reply)

        print("âœ… Assistant reply (cleaned):", final_reply)
        return jsonify({"reply": final_reply})

    except Exception as e:
        print("ðŸ”¥ ERROR:")
        traceback.print_exc()
        return jsonify({"error": str(e)}), 500

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=int(os.environ.get("PORT", 5000)))

